# 短链接项目功能模块清单

### 一、 核心模块 (Core Modules)

#### 1. 用户与认证模块 (User & Authentication)
这是整个权限系统和个性化服务的基础。

- **用户注册**：
    - 提供用户名/密码、邮箱注册。
- **用户登录**：
    - 登录成功后，签发 JWT (JSON Web Token) 用于后续的 API 认证。
- **用户信息管理**：
    - 用户查看和修改自己的基本信息（如修改密码）。
- **登出**：
    - 客户端删除 JWT 或服务端实现 Token 黑名单。

#### 2. 短链接核心模块 (Short-Link Core)
项目的核心业务功能。

- **短链接生成**：
    - **API 接口**：接收原始长链接，返回短链接。
    - **算法**：
        - `自增 ID 转 Base62`：最常用，可以保证短码唯一且长度递增。
        - `哈希截断`：(如 MurmurHash/MD5) 对长链接哈希，取前N位，需处理哈希碰撞。
    - **自定义短码**：允许用户（可能是特定权限）自定义短链接的后缀。
    - **链接设置**：设置过期时间、设置密码访问等。
- **短链接重定向**：
    - 核心服务，通过 `HTTP 301/302` 重定向。
    - **性能**：必须是高性能接口，通常会使用 Redis 等缓存加速查找。
    - **日志记录**：重定向的同时，异步触发“访问日志收集”事件（为报表模块提供数据）。
- **短链接管理 (CRUD)**：
    - **创建**：调用“短链接生成”服务。
    - **读取**：查看用户自己创建的短链接列表及详情。
    - **更新**：修改短链接的目标地址、过期时间等。
    - **删除**：删除短链接（软删除或硬删除）。

---

### 二、 权限管理模块 (Permission Management - Casbin)

#### 3. Casbin 权限模块
实现精细化的访问控制 (RBAC 或 ABAC)。

- **Casbin Enforcer**：
    - 加载 Casbin 模型 (Model) 和策略 (Policy)。
- **Casbin 适配器 (Adapter)**：
    - 持久化策略规则，例如使用 GORM Adapter 将规则存入 MySQL/PostgreSQL。
- **权限中间件 (Middleware)**：
    - 拦截所有受保护的 API 请求。
    - 从 JWT 中解析 `sub` (用户 ID 或角色)。
    - 获取请求的 `obj` (资源，如 `/api/v1/links`) 和 `act` (操作，如 `POST`)。
    - 调用 `Enforcer.Enforce(sub, obj, act)` 进行鉴权。
- **角色管理 (RBAC)**：
    - 定义角色（如 `guest`, `user`, `admin`）。
    - **API 接口**：
        - `添加/删除用户角色` (e.g., `g, alice, user`)。
        - `添加/删除角色权限` (e.g., `p, user, /api/links, POST`)。
- **策略管理 API**：
    - （可选，通常为管理员使用）提供增删改查 Casbin 策略规则的接口。

**Casbin 策略示例 (RBAC Model)：**
- `guest` 只能访问重定向接口和登录注册。
- `user` 可以创建和管理 *自己* 的短链接，可以查看 *自己* 的报表。
- `admin` 可以管理 *所有* 用户的短链接和查看 *所有* 报表，并管理用户角色。

---

### 三、 报表与分析模块 (Reporting & Analytics)

#### 4. 访问数据收集模块 (Data Collection)
在重定向时异步收集数据，避免阻塞主流程。

- **异步日志通道**：
    - 重定向服务产生日志后，将其推送到 Go Channel。
    - 由后台 Goroutine 消费 Channel，批量写入。
- **消息队列（可选）**：
    - 当流量巨大时，可使用 Kafka 或 RabbitMQ 替换 Go Channel，实现更可靠的数据收集。
- **日志内容**：
    - 短链接 Code
    - 访问时间 (Timestamp)
    - 访问者 IP 地址
    - User-Agent (浏览器、操作系统)
    - Referer (来源网站)

#### 5. 数据处理与存储模块 (Data Processing & Storage)
- **数据存储**：
    - **关系型数据库 (MySQL/PostgreSQL)**：适合存储聚合后的统计结果。
    - **时序/分析型数据库 (ClickHouse/Elasticsearch)**：非常适合存储原始访问日志，查询分析性能极高。
- **数据清洗与聚合 (ETL)**：
    - **IP 转地理位置**：使用 IP 地理库 (如 MaxMind GeoIP) 解析 IP，获取国家、城市。
    - **User-Agent 解析**：解析 UA 字符串，获取浏览器类型、操作系统、设备类型。
    - **定时任务 (Cron)**：
        - 定期（如每小时或每天）对原始日志进行聚合，生成统计报表数据，存入 RDBMS，供 API 快速查询。

#### 6. 报表 API 模块 (Report API)
提供数据给前端图表展示。

- **总览数据 API**：
    - 总点击量、总链接数、今日点击量。
- **趋势分析 API**：
    - 按时间（小时/天/月）聚合的点击量（用于绘制折线图）。
- **来源分析 API**：
    - Top Referers 列表（用于饼图或柱状图）。
- **地理位置 API**：
    - 按国家/城市分布的点击量（用于地图或列表）。
- **设备分析 API**：
    - 按浏览器、操作系统、设备类型的点击量分布。
- **链接明细 API**：
    - 单个短链接的详细访问报表。

---

### 四、 通用与系统模块 (Common & System)

#### 7. 系统基础模块
- **配置管理**：
    - 使用 `Viper` 等库管理配置（数据库、Redis、Casbin 模型路径、JWT Secret 等）。
- **数据库 ORM**：
    - 使用 `GORM` 或 `sqlx` 管理数据库（用户、短链接、Casbin 策略）。
- **Redis 缓存**：
    - 缓存 `短码 -> 长链接` 的映射，加速重定向。
    - 缓存用户信息、JWT 黑名单等。
- **日志系统**：
    - 使用 `Zap` 或 `Logrus` 记录应用运行日志（Error, Info, Debug），区别于“访问分析日志”。
- **全局错误处理**：
    - 统一的错误响应格式。
- **API 文档**：
    - 使用 `Swagger/OpenAPI` (如 `swag`) 自动生成 API 文档。